name: Docker Build and Push

on:
  push:
    branches: [main, master, develop, 'v*-preview']
    tags: ['v*']
  pull_request:
    branches: [main, master, develop, 'v*-preview']
  workflow_dispatch:
    inputs:
      build_version:
        description: 'æž„å»ºç‰ˆæœ¬ (ä¾‹å¦‚: latest, v1.0.0)'
        required: true
        default: 'latest'

# çŽ¯å¢ƒå˜é‡é…ç½®
env:
  # ç»Ÿä¸€ä½¿ç”¨åŒä¸€ä¸ªä»“åº“å
  DOCKER_REPOSITORY: ${{ github.repository }}
  # Docker Hub ç”¨æˆ·åï¼Œå°†åœ¨æ­¥éª¤ä¸­ä»Ž secrets èŽ·å–
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  test:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run tests
        run: |
          echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          # è¿™é‡Œæ·»åŠ æ‚¨çš„æµ‹è¯•å‘½ä»¤

  build-and-push:
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        component: [frontend, backend]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get build metadata
        id: metadata
        run: |
          # èŽ·å–æž„å»ºæ—¶é—´ï¼ˆæ¯«ç§’çº§ï¼‰
          BUILD_TIME_MS=$(date -u +'%Y%m%d%H%M%S%3N')
          echo "build_time_ms=${BUILD_TIME_MS}" >> $GITHUB_OUTPUT
          
          # èŽ·å–å½“å‰åˆ†æ”¯åï¼ˆæ¸…ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BRANCH_NAME=${BRANCH_NAME//\//-}
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„è§ˆåˆ†æ”¯
          if [[ "$BRANCH_NAME" == *"preview"* ]] || [[ "${{ github.event.inputs.build_version }}" == *"preview"* ]]; then
            echo "is_preview=true" >> $GITHUB_OUTPUT
          else
            echo "is_preview=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Build time: ${BUILD_TIME_MS}"
          echo "Branch: ${BRANCH_NAME}"

      - name: Generate Docker tags
        id: tags
        run: |
          FULL_REPO_NAME="${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}"
          COMPONENT="${{ matrix.component }}"
          BRANCH_NAME="${{ steps.metadata.outputs.branch_name }}"
          BUILD_TIME_MS="${{ steps.metadata.outputs.build_time_ms }}"
          IS_PREVIEW="${{ steps.metadata.outputs.is_preview }}"
          
          TAGS=()
          
          if [[ "$IS_PREVIEW" == "true" ]]; then
            # é¢„è§ˆåˆ†æ”¯çš„æ ‡ç­¾è§„åˆ™
            TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-latest-${BRANCH_NAME}")
            TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-latest-${BRANCH_NAME}-${BUILD_TIME_MS}")
            TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-latest-preview")
          else
            # ä¸»åˆ†æ”¯çš„æ ‡ç­¾è§„åˆ™
            if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
              TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-main-latest")
              TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-main-${BUILD_TIME_MS}")
              TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-latest")
            else
              # å…¶ä»–ç¨³å®šåˆ†æ”¯
              TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-latest-${BRANCH_NAME}")
              TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-latest-${BRANCH_NAME}-${BUILD_TIME_MS}")
              TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-latest")
            fi
          fi
          
          # å¦‚æžœæ˜¯æ ‡ç­¾æŽ¨é€ï¼Œæ·»åŠ ç‰ˆæœ¬æ ‡ç­¾
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-${VERSION}")
          fi
          
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.build_version }}" != "latest" ]]; then
            MANUAL_VERSION="${{ github.event.inputs.build_version }}"
            TAGS+=("${FULL_REPO_NAME}:${COMPONENT}-${MANUAL_VERSION}")
          fi
          
          # è¾“å‡ºæ ‡ç­¾åˆ—è¡¨
          TAGS_JSON=$(printf '%s\n' "${TAGS[@]}" | jq -R . | jq -s .)
          echo "tags=${TAGS_JSON}" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºé€—å·åˆ†éš”çš„æ ‡ç­¾å­—ç¬¦ä¸²ç”¨äºŽæž„å»º
          TAGS_STRING=$(IFS=,; echo "${TAGS[*]}")
          echo "tags_string=${TAGS_STRING}" >> $GITHUB_OUTPUT
          
          echo "Generated tags for ${COMPONENT}:"
          printf '%s\n' "${TAGS[@]}"

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}
          tags: |
            type=raw,value=${{ fromJSON(steps.tags.outputs.tags)[0] }}
          labels: |
            org.opencontainers.image.created=${{ fromJSON(steps.tags.outputs.tags)[0] }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ github.ref_name }}
            com.github.component=${{ matrix.component }}

      - name: Build and push ${{ matrix.component }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.${{ matrix.component }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags_string }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_TIME=${{ steps.metadata.outputs.build_time_ms }}
            BUILD_VERSION=${{ github.ref_name }}
            GIT_COMMIT=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update summary for ${{ matrix.component }}
        if: matrix.component == 'backend'
        run: |
          echo "## Docker Images Published ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: ${{ steps.metadata.outputs.build_time_ms }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ steps.metadata.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºç±»åž‹**: ${{ steps.metadata.outputs.is_preview == 'true' && 'é¢„è§ˆç‰ˆ' || 'ç¨³å®šç‰ˆ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ç‰ˆæœ¬**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Multi-Architecture Support" >> $GITHUB_STEP_SUMMARY
          echo "âœ… linux/amd64 (Intel/AMD x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… linux/arm64 (Apple Silicon, Raspberry Pi, AWS Graviton)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Add component summary
        run: |
          COMPONENT="${{ matrix.component }}"
          TAGS=(${{ steps.tags.outputs.tags_string }})
          
          echo "### ${COMPONENT^} Images Published" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          for tag in "${TAGS[@]}"; do
            echo "$tag" >> $GITHUB_STEP_SUMMARY
          done
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  final-summary:
    if: always() && needs.build-and-push.result != 'skipped'
    runs-on: ubuntu-latest
    needs: [build-and-push]
    steps:
      - name: Complete summary
        run: |
          echo "### ä½¿ç”¨ç¤ºä¾‹" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–æœ€æ–°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:frontend-latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:backend-latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–ç‰¹å®šç‰ˆæœ¬çš„é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:frontend-latest-preview" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPOSITORY }}:backend-main-latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æž„å»ºå®ŒæˆäºŽ: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
name: Docker Build & Publish

on:
  # 4. 有更新即自动构建
  push:
    branches: ["**"]          # 所有分支
    tags: ["v*"]
  pull_request:
    branches: [main, develop]
  # 1. 手动构建 + 动态获取所有分支
  workflow_dispatch:
    inputs:
      latest_target:
        description: "Which branch should get the 'latest' tag"
        required: true
        default: "auto"
        type: choice
        options: ["auto"]   # 运行时通过接口把全量分支插进来

env:
  DOCKERHUB_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}
  # 2. yml 里配置自动 latest 规则（go 风格正则）
  AUTO_LATEST_REGEX: "^refs/heads/main$|^refs/tags/v[0-9]+\\.[0-9]+\\.[0-9]+$"

jobs:
  # --------------  动态生成下拉框  --------------
  generate-inputs:
    runs-on: ubuntu-latest
    outputs:
      latest-options: ${{ steps.branches.outputs.list }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Collect all branches
        id: branches
        run: |
          # 获取远程所有分支名，去掉 origin/ 前缀，拼成 JSON 数组字符串
          mapfile -t BRANCHES < <(git ls-remote --heads origin | awk '{print $2}' | sed 's|refs/heads/||' | sort -u)
          JSON=$(printf '"%s",' "${BRANCHES[@]}")
          JSON="[${JSON%,}]"   # 去掉末尾逗号
          echo "list=$JSON" >> $GITHUB_OUTPUT

  # --------------  真正构建  --------------
  build:
    needs: generate-inputs
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    strategy:
      matrix:
        include:
          - img: tradingagents-backend
            dockerfile: ./Dockerfile.backend
          - img: tradingagents-frontend
            dockerfile: ./Dockerfile.frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate vars
        id: vars
        run: |
          echo "BUILD_DATE=$(date -u +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          # 当前分支名（push 时）
          echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      # 决定 latest 及是否打「分支-时间」
      - name: Decide flags
        id: flag
        run: |
          # 手动触发
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SEL="${{ github.event.inputs.latest_target }}"
            if [[ "$SEL" != "auto" ]]; then
              [[ "$GITHUB_REF" == "refs/heads/$SEL" ]] && IS_LATEST=true || IS_LATEST=false
            else
              IS_LATEST=$(echo "$GITHUB_REF" | grep -P '${{ env.AUTO_LATEST_REGEX }}' && echo true || echo false)
            fi
          else
            # 自动触发
            IS_LATEST=$(echo "$GITHUB_REF" | grep -P '${{ env.AUTO_LATEST_REGEX }}' && echo true || echo false)
          fi
          # 任何分支都启用「分支-时间」
          BRANCH_TIME=false
          [[ "$GITHUB_REF" == refs/heads/* ]] && BRANCH_TIME=true
          echo "IS_LATEST=$IS_LATEST" >> $GITHUB_OUTPUT
          echo "BRANCH_TIME=$BRANCH_TIME" >> $GITHUB_OUTPUT

      # 生成元数据
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_NAMESPACE }}/${{ matrix.img }}
          flavor: |
            latest=false
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=raw,value=latest,enable=${{ steps.flag.outputs.IS_LATEST }}
            # 3. 分支-构建时间
            type=raw,value=${{ steps.vars.outputs.BRANCH_NAME }}-${{ steps.vars.outputs.BUILD_DATE }},enable=${{ steps.flag.outputs.BRANCH_TIME }}
            # 统一日期+sha
            type=raw,value=build-${{ steps.vars.outputs.BUILD_DATE }}-${{ steps.vars.outputs.SHORT_SHA }}

      - name: Build & push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            COMMIT_SHA=${{ github.sha }}
            BUILD_DATE=${{ steps.vars.outputs.BUILD_DATE }}

  # --------------  PR 仅构建不推送  --------------
  pr-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.merged != true
    strategy:
      matrix:
        include:
          - img: tradingagents-backend
            dockerfile: ./Dockerfile.backend
          - img: tradingagents-frontend
            dockerfile: ./Dockerfile.frontend
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: false
          tags: ${{ matrix.img }}:pr-${{ github.event.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
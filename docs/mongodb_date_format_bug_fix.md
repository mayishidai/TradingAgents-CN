# MongoDB æ—¥æœŸæ ¼å¼ Bug ä¿®å¤æ–‡æ¡£

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šåœ¨åˆ†æè‚¡ç¥¨æ—¶ï¼Œåç«¯æ—¥å¿—æ˜¾ç¤ºï¼š

```
2025-10-12 19:12:36,788 | dataflows | WARNING | âš ï¸ [æ•°æ®æ¥æº: MongoDB] æœªæ‰¾åˆ°dailyæ•°æ®: 601288ï¼Œé™çº§åˆ°å…¶ä»–æ•°æ®æº
2025-10-12 19:12:36,790 | dataflows | ERROR | ğŸ”„ mongodbå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ•°æ®æºè·å–dailyæ•°æ®...
```

ä½†æ˜¯ï¼ŒMongoDB çš„ `stock_daily_quotes` é›†åˆä¸­**ç¡®å®å­˜åœ¨** 601288 çš„ daily æ•°æ®ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### 1. æ•°æ®å­˜åœ¨æ€§éªŒè¯

é€šè¿‡ MongoDB å®¢æˆ·ç«¯æŸ¥è¯¢ï¼Œç¡®è®¤æ•°æ®å­˜åœ¨ï¼š

```javascript
db.getCollection("stock_daily_quotes").find({ "symbol": "601288" }).limit(1000).skip(0)
```

ç»“æœæ˜¾ç¤ºï¼š
- âœ… æœ‰å¤§é‡ 601288 çš„æ•°æ®
- âœ… `period` å­—æ®µä¸º `"daily"`
- âœ… `trade_date` å­—æ®µä¸ºå­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¦‚ `"2024-10-09"`ï¼‰

### 2. æŸ¥è¯¢å¤±è´¥åŸå› 

é€šè¿‡è°ƒè¯•è„šæœ¬å‘ç°ï¼Œé—®é¢˜å‡ºåœ¨ `app/routers/stocks.py` ç¬¬ 202 è¡Œï¼š

**é”™è¯¯ä»£ç **ï¼š
```python
start_date = (datetime.now() - timedelta(days=limit * 2)).strftime("%Y-%m-d")
#                                                                         â†‘
#                                                                    å°‘äº†ä¸€ä¸ª %
```

**æ­£ç¡®ä»£ç **ï¼š
```python
start_date = (datetime.now() - timedelta(days=limit * 2)).strftime("%Y-%m-%d")
#                                                                         â†‘
#                                                                    åº”è¯¥æ˜¯ %d
```

### 3. Bug å½±å“

**é”™è¯¯æ ¼å¼ç¤ºä¾‹**ï¼š
- åº”è¯¥æ˜¯ï¼š`"2025-03-26"`
- å®é™…æ˜¯ï¼š`"2025-03-d"`

è¿™å¯¼è‡´ MongoDB æŸ¥è¯¢æ¡ä»¶å˜æˆï¼š

```python
{
    "symbol": "601288",
    "period": "daily",
    "trade_date": {"$gte": "2025-03-d", "$lte": "2025-10-12"}  # âŒ é”™è¯¯çš„æ—¥æœŸæ ¼å¼
}
```

ç”±äº `"2025-03-d"` ä¸æ˜¯æœ‰æ•ˆçš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ŒMongoDB çš„å­—ç¬¦ä¸²æ¯”è¾ƒä¼šå¤±è´¥ï¼Œå¯¼è‡´æŸ¥è¯¢ä¸åˆ°ä»»ä½•æ•°æ®ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹çš„æ–‡ä»¶

**æ–‡ä»¶**ï¼š`app/routers/stocks.py`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 202 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š

```python
# ä¿®å¤å‰
start_date = (datetime.now() - timedelta(days=limit * 2)).strftime("%Y-%m-d")

# ä¿®å¤å
start_date = (datetime.now() - timedelta(days=limit * 2)).strftime("%Y-%m-%d")
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† `scripts/test_date_format_fix.py` æµ‹è¯•è„šæœ¬ã€‚

### æµ‹è¯•ç»“æœ

```
âŒ ä¿®å¤å‰çš„æ ¼å¼ï¼ˆé”™è¯¯ï¼‰ï¼š
  end_date: 2025-10-12
  start_date: 2025-03-d
  âš ï¸ start_date æ ¼å¼é”™è¯¯ï¼åº”è¯¥æ˜¯ YYYY-MM-DDï¼Œå®é™…æ˜¯ YYYY-MM-d

âœ… ä¿®å¤åçš„æ ¼å¼ï¼ˆæ­£ç¡®ï¼‰ï¼š
  end_date: 2025-10-12
  start_date: 2025-03-26
  âœ… start_date æ ¼å¼æ­£ç¡®ï¼

âœ… æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° 131 æ¡æ•°æ®
  æ—¥æœŸèŒƒå›´: 2025-03-26 ~ 2025-10-09

âœ… é€‚é…å™¨æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° 131 æ¡æ•°æ®
  æ—¥æœŸèŒƒå›´: 2025-03-26 ~ 2025-10-09
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ MongoDB æŸ¥è¯¢å¤±è´¥ï¼ˆæ—¥æœŸæ ¼å¼é”™è¯¯ï¼‰
- âŒ é™çº§åˆ°å¤–éƒ¨ APIï¼ˆakshareï¼‰
- âŒ æŸ¥è¯¢é€Ÿåº¦æ…¢
- âŒ æ—¥å¿—æ˜¾ç¤ºè­¦å‘Šå’Œé”™è¯¯

### ä¿®å¤å

- âœ… MongoDB æŸ¥è¯¢æˆåŠŸ
- âœ… ç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®
- âœ… æŸ¥è¯¢é€Ÿåº¦å¿«
- âœ… æ— è­¦å‘Šå’Œé”™è¯¯

## ğŸ” æ ¹æœ¬åŸå› 

è¿™æ˜¯ä¸€ä¸ª**æ‹¼å†™é”™è¯¯**ï¼ˆtypoï¼‰ï¼š

- Python çš„ `strftime` æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­ï¼š
  - `%Y` = 4ä½å¹´ä»½ï¼ˆå¦‚ 2025ï¼‰
  - `%m` = 2ä½æœˆä»½ï¼ˆå¦‚ 03ï¼‰
  - `%d` = 2ä½æ—¥æœŸï¼ˆå¦‚ 26ï¼‰

- é”™è¯¯å†™æˆ `"%Y-%m-d"` ä¼šè¢«è§£é‡Šä¸ºï¼š
  - `%Y` = 2025
  - `%m` = 03
  - `-d` = å­—é¢é‡å­—ç¬¦ä¸² "d"ï¼ˆä¸æ˜¯æ ¼å¼åŒ–ç¬¦å·ï¼‰

## ğŸ’¡ é¢„é˜²æªæ–½

### 1. ä»£ç å®¡æŸ¥

åœ¨ä»£ç å®¡æŸ¥æ—¶ï¼Œç‰¹åˆ«æ³¨æ„æ—¥æœŸæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ­£ç¡®æ€§ã€‚

### 2. å•å…ƒæµ‹è¯•

ä¸ºæ—¥æœŸæ ¼å¼åŒ–æ·»åŠ å•å…ƒæµ‹è¯•ï¼š

```python
def test_date_format():
    """æµ‹è¯•æ—¥æœŸæ ¼å¼åŒ–"""
    limit = 100
    start_date = (datetime.now() - timedelta(days=limit * 2)).strftime("%Y-%m-%d")
    
    # éªŒè¯æ ¼å¼
    assert len(start_date) == 10  # YYYY-MM-DD é•¿åº¦ä¸º 10
    assert start_date[4] == '-'
    assert start_date[7] == '-'
    assert start_date[-1].isdigit()  # æœ€åä¸€ä¸ªå­—ç¬¦åº”è¯¥æ˜¯æ•°å­—ï¼Œä¸æ˜¯ 'd'
```

### 3. ç±»å‹æ£€æŸ¥

ä½¿ç”¨ç±»å‹æç¤ºå’Œé™æ€åˆ†æå·¥å…·ï¼ˆå¦‚ mypyï¼‰æ¥æ£€æµ‹æ½œåœ¨çš„æ ¼å¼é”™è¯¯ã€‚

### 4. æ—¥å¿—éªŒè¯

åœ¨æŸ¥è¯¢å‰è®°å½•æ—¥æœŸå‚æ•°ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼š

```python
logger.debug(f"ğŸ“… æŸ¥è¯¢æ—¥æœŸèŒƒå›´: {start_date} ~ {end_date}")
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

1. âœ… `app/routers/stocks.py` - ä¿®å¤æ—¥æœŸæ ¼å¼é”™è¯¯
2. âœ… `scripts/test_date_format_fix.py` - æµ‹è¯•è„šæœ¬
3. âœ… `scripts/debug_mongodb_query.py` - è°ƒè¯•è„šæœ¬
4. âœ… `scripts/debug_mongodb_daily_data.py` - æ•°æ®éªŒè¯è„šæœ¬

## ğŸ¯ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªç®€å•ä½†å½±å“é‡å¤§çš„ Bugï¼š

- **åŸå› **ï¼šæ—¥æœŸæ ¼å¼åŒ–å­—ç¬¦ä¸²æ‹¼å†™é”™è¯¯ï¼ˆ`%Y-%m-d` åº”è¯¥æ˜¯ `%Y-%m-%d`ï¼‰
- **å½±å“**ï¼šå¯¼è‡´ MongoDB æŸ¥è¯¢å¤±è´¥ï¼Œç³»ç»Ÿé™çº§åˆ°å¤–éƒ¨ API
- **ä¿®å¤**ï¼šä¿®æ­£æ ¼å¼åŒ–å­—ç¬¦ä¸²
- **éªŒè¯**ï¼šé€šè¿‡æµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤æ•ˆæœ

ä¿®å¤åï¼ŒMongoDB ç¼“å­˜åŠŸèƒ½æ¢å¤æ­£å¸¸ï¼ŒæŸ¥è¯¢é€Ÿåº¦æ˜¾è‘—æå‡ï¼ğŸ‰

## ğŸ“… ä¿®å¤æ—¥æœŸ

2025-10-12


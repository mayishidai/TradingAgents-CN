# é—®é¢˜è§£å†³ï¼šæ¨¡å‹é…ç½®æœªä¿å­˜åˆ°æ•°æ®åº“

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šåœ¨å‰ç«¯"è®¾ç½®" â†’ "ç³»ç»Ÿè®¾ç½®"ä¸­é…ç½®çš„ `quick_analysis_model` å’Œ `deep_analysis_model` æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¯¼è‡´ç³»ç»Ÿä»ç„¶ä½¿ç”¨é»˜è®¤çš„ `qwen-turbo` æ¨¡å‹ï¼Œè€Œä¸æ˜¯ç”¨æˆ·é…ç½®çš„ `qwen-flash` å’Œ `qwen3-max`ã€‚

## ğŸ” é—®é¢˜æ’æŸ¥è¿‡ç¨‹

### 1. åˆæ­¥æ£€æŸ¥

- **å‰ç«¯æäº¤çš„æ•°æ®**ï¼šç¡®è®¤å‰ç«¯ç¡®å®æäº¤äº†è¿™ä¸¤ä¸ªå­—æ®µ
  ```json
  {
    "quick_analysis_model": "qwen-flash",
    "deep_analysis_model": "qwen3-max",
    ...
  }
  ```

- **åç«¯æ¥æ”¶æƒ…å†µ**ï¼šæ·»åŠ æ—¥å¿—åç¡®è®¤åç«¯æˆåŠŸæ¥æ”¶åˆ°è¿™ä¸¤ä¸ªå­—æ®µ
  ```
  ğŸ“ æ¥æ”¶åˆ°çš„ç³»ç»Ÿè®¾ç½®æ›´æ–°è¯·æ±‚ï¼ŒåŒ…å« 25 é¡¹
    âœ“ quick_analysis_model: qwen-flash
    âœ“ deep_analysis_model: qwen3-max
  ```

### 2. æ·±å…¥æ’æŸ¥

æ·»åŠ è¯¦ç»†æ—¥å¿—è·Ÿè¸ªé…ç½®ä¿å­˜æµç¨‹ï¼š

```python
# app/services/config_service.py - update_system_settings()
ğŸ“ æ›´æ–°å‰ system_settings åŒ…å« 33 é¡¹
  âœ“ æ›´æ–°å‰åŒ…å« quick_analysis_model: qwen-flash
ğŸ“ æ›´æ–°å system_settings åŒ…å« 33 é¡¹
  âœ“ æ›´æ–°ååŒ…å« quick_analysis_model: qwen-flash
  âœ“ æ›´æ–°ååŒ…å« deep_analysis_model: qwen3-max

# app/services/config_service.py - save_system_config()
ğŸ“ å³å°†ä¿å­˜çš„ system_settings åŒ…å« 33 é¡¹
  âœ“ åŒ…å« quick_analysis_model: qwen-flash
  âœ“ åŒ…å« deep_analysis_model: qwen3-max
ğŸ“ æ–°é…ç½®ID: 68e525828f5ef72e9217fa30
âœ… é…ç½®ä¿å­˜æˆåŠŸ
```

### 3. å‘ç°æ ¹æœ¬åŸå› 

é—®é¢˜å‡ºåœ¨**æ•°æ®åº“æŸ¥è¯¢è„šæœ¬**ä¸Šï¼

**é”™è¯¯çš„æŸ¥è¯¢æ–¹å¼**ï¼š
```python
# scripts/check_provider_values.py (æ—§ç‰ˆæœ¬)
system_config = await db['system_configs'].find_one({})
```

è¿™ä¼šè¿”å›**ç¬¬ä¸€ä¸ª**æ–‡æ¡£ï¼ˆé€šå¸¸æ˜¯æ—§çš„é…ç½®ï¼‰ï¼Œè€Œä¸æ˜¯æœ€æ–°çš„æ¿€æ´»é…ç½®ã€‚

**æ­£ç¡®çš„æŸ¥è¯¢æ–¹å¼**ï¼š
```python
# scripts/check_provider_values.py (ä¿®å¤å)
system_config = await db['system_configs'].find_one(
    {"is_active": True},
    sort=[("version", -1)]
)
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤æ•°æ®åº“æŸ¥è¯¢è„šæœ¬

ä¿®æ”¹ `scripts/check_provider_values.py`ï¼Œä½¿ç”¨æ­£ç¡®çš„æŸ¥è¯¢æ¡ä»¶ï¼š

```python
# æŸ¥è¯¢æœ€æ–°çš„æ¿€æ´»é…ç½®
system_config = await db['system_configs'].find_one(
    {"is_active": True},
    sort=[("version", -1)]
)
```

### 2. æ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—ï¼Œæ–¹ä¾¿åç»­æ’æŸ¥é—®é¢˜ï¼š

**app/routers/config.py**ï¼š
```python
@router.put("/settings", response_model=dict)
async def update_system_settings(...):
    # æ‰“å°æ¥æ”¶åˆ°çš„è®¾ç½®
    logger.info(f"ğŸ“ æ¥æ”¶åˆ°çš„ç³»ç»Ÿè®¾ç½®æ›´æ–°è¯·æ±‚ï¼ŒåŒ…å« {len(settings)} é¡¹")
    if 'quick_analysis_model' in settings:
        logger.info(f"  âœ“ quick_analysis_model: {settings['quick_analysis_model']}")
    if 'deep_analysis_model' in settings:
        logger.info(f"  âœ“ deep_analysis_model: {settings['deep_analysis_model']}")
```

**app/services/config_service.py**ï¼š
```python
async def update_system_settings(self, settings: Dict[str, Any]) -> bool:
    # æ‰“å°æ›´æ–°å‰åçš„çŠ¶æ€
    print(f"ğŸ“ æ›´æ–°å‰ system_settings åŒ…å« {len(config.system_settings)} é¡¹")
    config.system_settings.update(settings)
    print(f"ğŸ“ æ›´æ–°å system_settings åŒ…å« {len(config.system_settings)} é¡¹")

async def save_system_config(self, config: SystemConfig) -> bool:
    # æ‰“å°å³å°†ä¿å­˜çš„æ•°æ®
    system_settings = config_dict.get('system_settings', {})
    print(f"ğŸ“ å³å°†ä¿å­˜çš„ system_settings åŒ…å« {len(system_settings)} é¡¹")
```

## ğŸ“Š éªŒè¯ç»“æœ

ä¿®å¤åï¼Œæ•°æ®åº“ä¸­æˆåŠŸä¿å­˜äº† 33 é¡¹ç³»ç»Ÿè®¾ç½®ï¼š

```json
{
  "max_concurrent_tasks": 3,
  "default_analysis_timeout": 300,
  "enable_cache": true,
  "cache_ttl": 3600,
  "log_level": "INFO",
  "enable_monitoring": true,
  "default_provider": "dashscope",
  "default_model": "qwen-turbo",
  "enable_cost_tracking": true,
  "cost_alert_threshold": 100,
  "currency_preference": "CNY",
  "quick_analysis_model": "qwen-flash",      // âœ… æˆåŠŸä¿å­˜
  "deep_analysis_model": "qwen3-max",        // âœ… æˆåŠŸä¿å­˜
  "worker_heartbeat_interval_seconds": 30,
  ...
}
```

## ğŸ¯ å…³é”®è¦ç‚¹

1. **MongoDB é…ç½®ç‰ˆæœ¬ç®¡ç†**ï¼š
   - ç³»ç»Ÿä½¿ç”¨ç‰ˆæœ¬åŒ–é…ç½®ç®¡ç†ï¼Œæ¯æ¬¡æ›´æ–°éƒ½ä¼šåˆ›å»ºæ–°æ–‡æ¡£
   - æ—§é…ç½®çš„ `is_active` è®¾ä¸º `False`
   - æ–°é…ç½®çš„ `is_active` è®¾ä¸º `True`ï¼Œ`version` é€’å¢

2. **æ­£ç¡®çš„æŸ¥è¯¢æ–¹å¼**ï¼š
   ```python
   # å§‹ç»ˆæŸ¥è¯¢æœ€æ–°çš„æ¿€æ´»é…ç½®
   config = await collection.find_one(
       {"is_active": True},
       sort=[("version", -1)]
   )
   ```

3. **é…ç½®åŒæ­¥æœºåˆ¶**ï¼š
   - æ•°æ®åº“ â†’ æ–‡ä»¶ç³»ç»Ÿï¼ˆ`config/settings.json`ï¼‰
   - æ•°æ®åº“ â†’ ç¯å¢ƒå˜é‡ï¼ˆå¯åŠ¨æ—¶æ¡¥æ¥ï¼‰
   - æ•°æ®åº“ â†’ å®šä»·é…ç½®ï¼ˆ`config/pricing.json`ï¼‰

## ğŸ”§ ç›¸å…³æ–‡ä»¶

- `app/routers/config.py` - é…ç½®ç®¡ç† API
- `app/services/config_service.py` - é…ç½®æœåŠ¡
- `app/models/config.py` - SystemConfig æ¨¡å‹å®šä¹‰
- `scripts/check_provider_values.py` - æ•°æ®åº“æ£€æŸ¥è„šæœ¬
- `app/core/config_bridge.py` - é…ç½®æ¡¥æ¥

## ğŸ“ åç»­å»ºè®®

1. **ç»Ÿä¸€æŸ¥è¯¢æ¥å£**ï¼šåˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ `get_active_config()` æ–¹æ³•ï¼Œé¿å…é‡å¤ä»£ç 
2. **æ·»åŠ é…ç½®å†å²æŸ¥çœ‹**ï¼šåœ¨å‰ç«¯æ·»åŠ é…ç½®å†å²è®°å½•åŠŸèƒ½
3. **é…ç½®å›æ»šåŠŸèƒ½**ï¼šæ”¯æŒå›æ»šåˆ°ä¹‹å‰çš„é…ç½®ç‰ˆæœ¬
4. **é…ç½®å¯¼å‡º/å¯¼å…¥**ï¼šæ”¯æŒé…ç½®çš„å¤‡ä»½å’Œæ¢å¤

---

**è§£å†³æ—¶é—´**ï¼š2025-10-07  
**é—®é¢˜çŠ¶æ€**ï¼šâœ… å·²è§£å†³

